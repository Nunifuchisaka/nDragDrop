!function(u,e){"use strict";e.nDragDrop=e.nDragDrop||{};function o(){console.count("Common"),l.$window=u(e),l.$body=u("body"),l.$clones=u('<div id="ndd_clones"></div>'),l.$body.append(l.$clones)}var l={$current:{drag:null,drop:null,select:null},$last:{select:null}};nDragDrop.draggable=function(e){_.bindAll(this,"init","mousedown","mousemove","mouseup","dragstart","dragging"),this.init(e)},nDragDrop.draggable.prototype.init=function(e){this.opts=u.extend({distance:2},e),console.group("nDragDrop.draggable init"),console.log(this.opts),console.groupEnd();this.status={drag:!1},this.vars={graspPosDiffX:0,graspPosDiffY:0,mousedownPageX:0,mousedownPageY:0,mousemoveStack:0},l.common=l.common||new o,this.$el=u(this.opts.el),this.$clone,l.$body.on("mousedown.ndd_draggable",this.opts.el,this.mousedown),l.$body.on("mouseup.ndd_draggable",this.mouseup)},nDragDrop.draggable.prototype.dragstart=function(e){l.$body.off("mousemove.ndd_drag_mousemove"),console.group("draggable dragstart");var d=l.$current.drag.offset();console.log("elOffset",d),l.$clones.show().css({top:d.top,left:d.left}),console.group("set position"),l.$current.drag.each(function(e,o){var t=u(o),s=t.offset(),n=t.clone().css({top:s.top-d.top,left:s.left-d.left});l.$clones.append(n)}),console.groupEnd(),l.$current.drag.css("visibility","hidden"),console.log("X : "+this.vars.graspPosDiffX,"Y : "+this.vars.graspPosDiffY),l.$body.on("mousemove.ndd_dragging",this.dragging),console.groupEnd()},nDragDrop.draggable.prototype.mousedown=function(e){console.group("draggable mousedown"),l.$current.drag=u(e.currentTarget).parent().find(this.opts.el),this.vars.mousedownPageX=e.pageX,this.vars.mousedownPageY=e.pageY;var o=l.$current.drag.offset();this.vars.graspPosDiffX=o.left-e.pageX,this.vars.graspPosDiffY=o.top-e.pageY,console.groupEnd(),l.$body.on("mousemove.ndd_drag_mousemove",this.mousemove)},nDragDrop.draggable.prototype.mousemove=function(e){console.group("draggable mousemove"),this.vars.mousemoveStack++,this.vars.mousemoveStack>this.opts.distance&&(this.vars.mousemoveStack=0,this.dragstart(e)),console.groupEnd()},nDragDrop.draggable.prototype.dragging=function(e){l.$clones.css({top:e.pageY+this.vars.graspPosDiffY,left:e.pageX+this.vars.graspPosDiffX})},nDragDrop.draggable.prototype.mouseup=function(e){l.$body.off("mousemove.ndd_drag_mousemove"),null!=l.$current.drag&&(console.group("draggable mouseup"),l.$body.off("mousemove.ndd_dragging"),l.$clones.hide().empty(),l.$current.drag.css("visibility","visible"),l.$current.drag=null,this.status.drag=!1,console.groupEnd())},nDragDrop.droppable=function(e){_.bindAll(this,"init","mouseenter","mouseleave","mouseup"),this.init(e)},nDragDrop.droppable.prototype.init=function(e){this.opts=u.extend({},e),console.group("droppable init"),console.log(this.opts),l.common=l.common||new o,this.$el=u(this.opts.el),this.$el.addClass("ndd_drop").on({mouseenter:this.mouseenter,mouseleave:this.mouseleave,mouseup:this.mouseup}),console.groupEnd()},nDragDrop.droppable.prototype.mouseenter=function(e){null!=l.$current.drag&&(console.log("ndd.$current.drag",l.$current.drag),l.$current.drop=u(e.currentTarget),console.log("ndd.$current.drop",l.$current.drop),1!=l.$current.drag.closest(l.$current.drop).length&&l.$current.drop.addClass("ndd_drop_active"))},nDragDrop.droppable.prototype.mouseleave=function(e){null!=l.$current.drop&&(console.group("drop mouseleave"),l.$current.drop.removeClass("ndd_drop_active"),l.$current.drop=null,console.groupEnd())},nDragDrop.droppable.prototype.mouseup=function(e){null!=l.$current.drop&&(this.mouseleave(e),console.group("drop mouseup"),console.log("ndd.$current.drag",l.$current.drag),console.groupEnd())},e.nSelectable=function(e){_.bindAll(this,"init","click","mousedown","mousemove","mouseup","keydown"),this.init(e)},nSelectable.prototype.init=function(e){this.opts=u.extend({selectee:"> *",excluse:null},e),l.common=l.common||new o,console.group("nSelectable init"),this.vars={startPosX:0,startPosY:0},this.$selectee,this.$selected,this.$el=u(this.opts.el),this.$el.each(function(e,o){var t=u(o).find(".ndd_selected");console.log(e,o,t.length),t.last().addClass("ndd_pivot")}),this.$helper=u('<div id="ndd_selectable_helper"><div></div></div>'),l.$body.on("mousedown.ndd_selectable",this.opts.el,this.mousedown),l.$body.on("mousemove.ndd_selectable",this.mousemove),l.$body.on("mouseup.ndd_selectable",this.mouseup),l.$body.on("click.ndd_selectable",this.opts.el+" "+this.opts.selectee,this.click),this.opts.excluse&&l.$body.on("mousedown",this.opts.excluse,this.excluse),console.groupEnd()},nSelectable.prototype.click=function(e){console.group("click");var o=u(e.currentTarget),t=o.parents(this.opts.el),s=t.find(".ndd_pivot");if(console.log("currentTarget",e.currentTarget),e.ctrlKey||e.metaKey||e.shiftKey||t.find(".ndd_selected").not(o).removeClass("ndd_selected"),e.ctrlKey||e.metaKey)if(o.hasClass("ndd_selected")){if(o.removeClass("ndd_selected ndd_pivot"),0==(s=t.find(".ndd_pivot")).length){var n=o.next(".ndd_selected");if(0<n.length)n.addClass("ndd_pivot");else{var d=o.prev(".ndd_selected");0<n.length?d.addClass("ndd_pivot"):t.find(".ndd_selected").eq(0).addClass("ndd_pivot")}s=t.find(".ndd_pivot")}}else s.removeClass("ndd_pivot"),t.find(".ndd_tmp").removeClass("ndd_tmp"),o.addClass("ndd_selected ndd_pivot"),s=t.find(".ndd_pivot");else o.addClass("ndd_selected");if(e.shiftKey){t.find(".ndd_tmp").removeClass("ndd_tmp ndd_selected"),0==s.length&&(t.find(this.opts.selectee).eq(0).addClass("ndd_pivot"),s=t.find(".ndd_pivot"));var r=o.index(),l=s.index();console.log("current",r),console.log("pivot",l);for(var a=Math.max(r,l),i=Math.min(r,l),c=t.find(this.opts.selectee),p=i;p<=a;p++)c.eq(p).addClass("ndd_selected"),p!=l&&c.eq(p).addClass("ndd_tmp")}o.hasClass("ndd_selected")&&(e.shiftKey||(t.find(".ndd_pivot").removeClass("ndd_pivot"),o.addClass("ndd_pivot"))),console.groupEnd()},nSelectable.prototype.excluse=function(e){console.count("excluse"),e.preventDefault(),e.stopPropagation()},nSelectable.prototype.mousedown=function(e){console.count("selectable mousedown"),l.$current.select=u(e.currentTarget),console.log("ndd.$current.select",l.$current.select),this.vars.startPosX=e.pageX,this.vars.startPosY=e.pageY,l.$body.append(this.$helper),this.$helper.css({top:e.pageY,left:e.pageX,width:0,height:0}),this.$selectee=l.$current.select.find(this.opts.selectee),console.log("this.$selectee",this.$selectee)},nSelectable.prototype.mousemove=function(e){if(null!=l.$current.select){var o,s=this,t=this.vars.startPosX,n=this.vars.startPosY,d=e.pageX,r=e.pageY;d<t&&(o=d,d=t,t=o),r<n&&(o=r,r=n,n=o),this.$helper.css({left:t,top:n,width:d-t,height:r-n}),this.$selectee.each(function(e,o){var t=u(o);t[function(e,o){var t=e.get(0).getBoundingClientRect(),s=o.get(0).getBoundingClientRect();return!(t.right<s.left||t.left>s.right||t.bottom<s.top||t.top>s.bottom)}(t,s.$helper)?"addClass":"removeClass"]("ndd_selected")})}},nSelectable.prototype.mouseup=function(e){console.count("selectable mouseup"),l.$current.select=null,this.$helper.remove(),console.log("this.$helper",this.$helper)},nSelectable.prototype.keydown=function(e){return!1}}(jQuery,this,this.document);